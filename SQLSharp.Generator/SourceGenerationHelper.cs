using System.Text;
using Microsoft.CodeAnalysis;
using SQLSharp.Generator.Result;

namespace SQLSharp.Generator;

public static class SourceGenerationHelper
{
    private static readonly DiagnosticDescriptor TypeIsNotPartial =
        new(
            "SQLSHARP001",
            "Annotated row type is not partial",
            "'{0}' must be partial to allow for adding extra behaviour",
            "FromRowGenerator",
            DiagnosticSeverity.Error,
            true);

    private static readonly DiagnosticDescriptor MissingPrimaryConstructor =
        new(
            "SQLSHARP002",
            "Could not find a primary constructor",
            "'{0}' does not have a primary constructor for row parsing",
            "FromRowGenerator",
            DiagnosticSeverity.Error,
            true);

    public const string RenameEnum =
        """
        // <auto-generated/>
        #nullable enable

        namespace SQLSharp.Generator.Result;
        
        public enum Rename
        {
            SnakeCase,
            CamelCase,
            PascalCase,
            UpperCase,
            LowerCase,
            None,
        }
        """;

    public const string FromRowAttribute =
        """
        // <auto-generated/>
        #nullable enable

        namespace SQLSharp.Generator.Result;

        [global::System.AttributeUsage(validOn: global::System.AttributeTargets.Class | global::System.AttributeTargets.Struct)]
        public sealed class FromRowAttribute : global::System.Attribute
        {
            public Rename RenameAll { get; set; } = Rename.None;
        }
        """;

    public const string ColumnAttribute =
        """
        // <auto-generated/>
        #nullable enable

        namespace SQLSharp.Generator.Result;

        [global::System.AttributeUsage(validOn: global::System.AttributeTargets.Parameter | global::System.AttributeTargets.Property)]
        public sealed class ColumnAttribute : global::System.Attribute
        {
            public string Rename { get; set; } = string.Empty;
            public bool Flatten { get; set; } = false;
        }
        """;

    public static string GenerateRowParserPartialClass(
        RowParserToGenerate rowParserToGenerate,
        SourceProductionContext sourceProductionContext)
    {
        if (!rowParserToGenerate.IsPartial)
        {
            sourceProductionContext.ReportDiagnostic(
                Diagnostic.Create(TypeIsNotPartial, Location.None,
                    rowParserToGenerate.Name));
            return string.Empty;
        }

        List<string> parameterNamespaces = [];
        ConstructorData? constructor;
        if (rowParserToGenerate.IsStruct)
        {
            constructor = rowParserToGenerate.Constructors
                .OrderByDescending(c => c.Parameters.Length)
                .FirstOrDefault();
        }
        else
        {
            constructor = rowParserToGenerate.Constructors
                .OrderBy(c => c.Parameters.Length)
                .FirstOrDefault();
        }

        if (constructor is null)
        {
            sourceProductionContext.ReportDiagnostic(
                Diagnostic.Create(MissingPrimaryConstructor, Location.None,
                    rowParserToGenerate.Name));
            return string.Empty;
        }

        var builder = new StringBuilder(constructor.Parameters.Length > 0
            ? "\n            "
            : string.Empty);
        for (var index = 0; index < constructor.Parameters.Length; index++)
        {
            ParameterData parameter = constructor.Parameters[index];
            if (!string.IsNullOrEmpty(parameter.TypeData.ContainingNamespace))
            {
                parameterNamespaces.Add(parameter.TypeData.ContainingNamespace);
            }
            
            var fieldName = parameter.HasRename
                ? parameter.ResultFieldName
                : rowParserToGenerate.Rename.TransformRowFieldName(parameter.ResultFieldName);

            builder.Append(parameter.Name);
            builder.Append(": ");

            if (parameter.Flatten)
            {
                builder.AppendFullTypeName(parameter.TypeData);
                builder.Append(".FromRow(row)");
                continue;
            }

            if (parameter.TypeData.IsDecode)
            {
                builder.AppendFullTypeName(parameter.TypeData);
                builder.Append(".Decode(row, row.IndexOf(\"");
                builder.Append(fieldName);
                builder.Append("\"))");
                continue;
            }

            builder.Append("row.GetField");
            if (!parameter.TypeData.IsNullable)
            {
                builder.Append("NotNull");
            }

            builder.Append('<');
            builder.AppendFullTypeName(parameter.TypeData);
            if (parameter.TypeData is { IsRefType: false, IsNullable: true })
            {
                builder.Append('?');
            }
            builder.Append('>');
            builder.Append("(\"");
            builder.Append(fieldName);
            builder.Append("\")");

            if (index >= constructor.Parameters.Length - 1) continue;

            builder.Append(',');
            builder.AppendLine();
            builder.Append("            ");
        }

        var type = rowParserToGenerate.IsStruct ? "struct" : "class";
        var typeNamespace = string.IsNullOrWhiteSpace(rowParserToGenerate.Namespace)
            ? string.Empty
            : $"{rowParserToGenerate.Namespace}.";
        return
            $$"""
              // <auto-generated/>
              #nullable enable
              
              partial {{typeNamespace}}{{type}} {{rowParserToGenerate.Name}} : SQLSharp.Result.IFromRow<{{rowParserToGenerate.Name}}>
              {
                  public static {{rowParserToGenerate.Name}} FromRow(SQLSharp.Result.IDataRow row)
                  {
                      return new {{rowParserToGenerate.Name}}({{builder}});
                  }
              }
              """;
    }

    private static void AppendFullTypeName(
        this StringBuilder builder,
        ParameterTypeData typeData)
    {
        if (!string.IsNullOrEmpty(typeData.ContainingNamespace))
        {
            builder.Append(typeData.ContainingNamespace);
            builder.Append('.');
        }
        builder.Append(typeData.Name);
    }

    public static string GetFullNamespaceName(this INamespaceSymbol namespaceSymbol)
    {
        if (string.IsNullOrEmpty(namespaceSymbol.Name))
        {
            return string.Empty;
        }
        
        StringBuilder builder = new(namespaceSymbol.Name);
        INamespaceSymbol currentNamespace = namespaceSymbol.ContainingNamespace;
        while (!string.IsNullOrEmpty(currentNamespace.Name))
        {
            builder.Insert(0, '.');
            builder.Insert(0, currentNamespace.Name);
            currentNamespace = currentNamespace.ContainingNamespace;
        }
        return builder.ToString();
    }
}